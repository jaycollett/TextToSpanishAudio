import requests
import time
import uuid

# Base URL for the API
API_BASE_URL = "http://localhost:5055"

def submit_job():
    # Generate a unique sermon GUID
    sermon_guid = str(uuid.uuid4())
    
    # Spanish transcription text for testing
    payload = {
        "sermon_guid": sermon_guid,
        "transcription": "EspañolHola a todos, espero que todos estén bien. Quería echar un vistazo a la lectura de las Escrituras para hoy del Evangelio de Mateo, capítulo 22. Y otra vez, Jesús les habló en parábolas, diciendo: El reino de los cielos puede compararse a un rey que hizo un banquete de bodas para su hijo, y envió a sus siervos a llamar a los que fueron invitados al banquete de bodas, pero no quisieron venir. De nuevo envió a otros siervos, diciendo: Decid a los invitados: Mirad, he preparado mi comida, mis bueyes y mis becerros engordados han sido sacrificados, y todo está listo. Venid al banquete de bodas. Pero ellos no hicieron caso, y se fueron, uno a su campo, otro a su negocio, mientras que el resto apresaron a sus siervos, los trataron vergonzosamente y los mataron. El rey se enojó, y envió sus tropas, y destruyó a aquellos asesinos, y quemó su ciudad. Luego dijo a sus siervos: El banquete de bodas está preparado, pero los invitados no eran dignos. Id, pues, al banquete de bodas. Id a los caminos principales, e invitad a la fiesta de bodas a cuantos encontréis. Y aquellos siervos salieron por los caminos, y reunieron a todos los que encontraron, tanto malos como buenos. Y la sala de bodas se llenó de invitados. Pero cuando el rey entró para ver a los invitados, vio allí a un hombre que no estaba vestido de boda. Y le dijo: Amigo, ¿cómo entraste aquí sin vestido de boda? Y él se quedó sin habla. Entonces el rey dijo a los sirvientes: Atadle las manos y los pies, y echadle en la cámara. Y él les dijo: Atadle las manos y los pies, y echadle en la cámara. Muéstrennos su insignia. Muéstrennos sus credenciales. Y Jesús dice: Bueno, les mostraré mis credenciales. Si responden a esta pregunta, ¿el bautismo de Juan era del cielo o del hombre? Por supuesto, se niegan a responder porque saben que los implicará. Es en ese contexto que Jesús da estas tres parábolas. La primera sobre el padre y los dos hijos que son llamados a trabajar en el campo. La siguiente sobre los labradores malvados. Y la última, esta, sobre la fiesta de bodas de un hijo. Observen que hay algunos temas comunes en todo esto. Todo tiene que ver con un padre, un padre que llama a sus hijos a trabajar en su campo, un dueño, un padre que exige fruto de una viña, y finalmente este padre que está invitando a la gente a la fiesta de bodas. Y, por supuesto, presentan al hijo o hijos. Así que todo esto tiene que ver con el padre y sus propósitos y cómo la gente se resiste a eso. Y, por supuesto, Jesús está tratando de desafiar a los líderes de Jerusalén con su resistencia a su gobierno y a su reino. Así que me gustaría destacar un par de cosas en esta parábola. La primera es que en esta parábola, el reino se compara con una fiesta de bodas. No es un funeral. Es un motivo de celebración y alegría. Y a veces la predicación del reino o nuestra comprensión del reino es algo sombrío. Y, por supuesto, hay comparaciones con el trabajo y está el tema de dar fruto. Pero esta es una celebración y nuestra comprensión del reino debe estar llena de un sentido de alegría, exuberancia y festividad. Y luego un comentario sobre aquellos que se resistieron. Observe que fueron invitados con anticipación. Eran personas que habían dicho, oh sí, nos encantaría ir a la boda de su hijo. Pero que cuando llegó el momento, no quisieron interrumpir sus vidas y renunciar a las cosas que estaban haciendo para ser parte de la fiesta de bodas. Y esto realmente afecta ese tema en el discipulado. Nos gusta la idea de ser seguidores de Jesús, pero cuando se trata de la implicación práctica real en mi vida de a quién estoy llamado a amar o qué podría estar llamado a renunciar. Nuevamente, piense en el joven rico. Él no quiere renunciar a su riqueza para ser un discípulo de Jesús. Él no quiere renunciar a su riqueza para ser un discípulo de Jesús. Él no quiere renunciar a su riqueza para ser un discípulo de Jesús. Él no quiere renunciar a su riqueza para ser un discípulo de Jesús. Él no quiere renunciar a su riqueza para ser un discípulo de Jesús. Y para ser parte de su reino. Y luego, un comentario sobre, oye, ¿cuál es el problema? Estas personas no vienen a la boda y por eso los matan. Creo que esto merece algún comentario. Observen que se trata de un rey. Esto no está en nuestro contexto moderno. Y observen que se niegan a asistir a la boda de su hijo. Observen que el hijo es el heredero del rey. Él es el que será el gobernante algún día. Y la conclusión es que se niegan a asistir a la boda de su hijo. Observen que el hijo es el heredero del rey. Él es el que será el gobernante algún día. Es rebelión. Esto es insurrección política. Recuerden que en el contexto de la historia, muy a menudo eran los herederos de los reyes cuyas vidas eran muy, muy frágiles porque la gente quería matarlos porque querían ser reyes en su lugar. Así que esta fiesta de bodas y la invitación a la fiesta de bodas, a ella, es una amenaza para todas las demás soberanías. Si no quiero renunciar a mi reino, si no quiero que mi reino sea interrumpido por el reino de este gran rey y su buen hijo, entonces estoy en la categoría de aquellos que dicen, realmente no quiero venir, y que se inventan excusas. Y honestamente, quién sabe, tal vez estas excusas sean algo así como, sí, tengo que lavarme el pelo. Tal vez todo se reduce a que rechazan ese reino. Observe también que dice que cuando se negaron o cuando no querían venir, algunos fueron a sus negocios y algunos a sus granjas. Creo que esto habla de todas las cosas buenas que Dios nos da y Dios nos llama a hacer, que si nuestros ídolos se convierten en ídolos que nos hacen rebeldes contra el rey y su reino. Dios nos da todas estas cosas buenas, pero como el joven rico, para que las llevemos, para que llevemos nuestras posesiones, para que llevemos nuestro trabajo que hacemos muy generosamente, estando dispuestos a dejar que se entregue para servir a los propósitos de seguir a Jesús dondequiera que nos llame a ir. Y el pueblo de Dios ha demostrado repetidamente que está dispuesto a no hacer nada con todas esas cosas buenas, pero estas personas se niegan a venir porque han hecho de esas cosas lo último. Finalmente, un comentario rápido sobre quién es quién en esta parábola. Quiero sugerir que los invitados que se negaron a venir y mataron a los mensajeros, quiero decir que eso habla de gran parte del Antiguo Testamento desde Moisés en adelante, los profetas que Dios envió a su pueblo para invitarlos a su casa y a ser parte de sus propósitos y cómo el pueblo de Dios se resistió continuamente. Y eso incluiría a los líderes de la iglesia, pero también el pueblo de Dios se resistió continuamente. Y eso incluiría a los líderes de la iglesia, pero también el pueblo de Dios se resistió continuamente. Y eso incluiría a los líderes de la iglesia, pero también el pueblo de Dios se resistió continuamente. Y eso incluiría a los líderes de la iglesia, pero también el pueblo de Dios se resistió continuamente. Y eso incluiría a los líderes de la iglesia, pero también el pueblo de Dios se resistió continuamente. Y eso incluiría a los líderes de la iglesia, pero también el pueblo de Dios se resistió continuamente. Y eso incluiría a los líderes de la iglesia, pero también al pueblo de Dios que resistía continuamente. Y eso incluiría a los líderes de la iglesia, pero también al pueblo de Dios que resistía continuamente. Y eso incluiría a los líderes de la iglesia, pero también al pueblo de Dios que resistía continuamente. Y eso incluiría a los líderes de la iglesia, pero también al pueblo de Dios que resistía continuamente. Y eso incluiría a los líderes de la iglesia, pero también al pueblo de Dios que resistía continuamente. Y eso incluiría a cualquiera que venga, bueno o malo, ese es claramente el ministerio de Jesús y el ministerio de los discípulos llamando a cualquiera, incluso a las prostitutas y a los recaudadores de impuestos, a los publicanos, a ser parte de este reino de gracia que Dios está estableciendo en su hijo Jesús. Y luego un comentario rápido sobre la ropa incorrecta o no tener un vestido de boda. Una vez más, esto no es solo mala educación. Esto no es solo vestirse incorrectamente para un evento de etiqueta. El problema aquí es que en las Escrituras, la ropa siempre es un símbolo de cosas más grandes. Y en este caso, creo que la ropa simboliza las obras justas que se requieren de aquellos que son llamados a ser parte del reino. Recuerden que en el Sermón del Monte, Jesús dice: “Si vuestra justicia no supera a la de los escribas y fariseos, no entraréis en el reino”. Así que Jesús está hablando aquí, o la parábola habla aquí de las enseñanzas de Jesús que fueron llamados a poner en práctica, no haciendo nuestra justicia delante de los demás, siendo aquellos que ponen fin al conflicto relacional, siendo aquellos que extienden el perdón y la generosidad del Padre a los demás. Y entonces este es un hombre que ha sido invitado a la casa, pero se niega a entrar y practicar las enseñanzas de Jesús. De hecho, podríamos decir que ha sido invitado a la casa, pero no está invitado a la casa. Ha sido invitado a la casa, pero no ha hecho nada malo. Así que podríamos decir que este es un hombre que ha sido invitado a la casa, perdonado amablemente por cualquier mal que haya hecho, pero se niega a extender esa maldad a los demás, solo para dar un ejemplo que Jesús ha dado repetidamente. Así que algunas preguntas para reflexionar sobre este pasaje de las Escrituras. Uno, ¿ha respondido a la invitación de asistir a la fiesta de bodas del hijo del rey? Recuerde, a todos nos gusta la idea del discipulado en general, pero cuando el discipulado es una cosa del pasado, no es una cosa del presente. Es una cosa del presente. Y entonces, cuando el discipulado es una cosa del pasado, no es una cosa del presente. Y entonces, cuando el discipulado es una cosa del pasado, no es una cosa del presente. Yo quiero cambiar la manera en que me relaciono y llevo a mi hermano en mi corazón, o perdonar a cierta persona, o dejar que mis posesiones se usen para bendecir a otros en lugar de simplemente acumularlas para mí, o tal vez incluso renunciar a las cosas muy buenas de mi vida cómoda por el bien de ser fiel al evangelio, como muchos cristianos han tenido que hacer. La pregunta es, cuando llega la invitación, no solo la invitación general, sino sígueme ahora, es una buena pregunta. ¿He respondido a esa invitación? Otra pregunta, ¿estoy usando el vestido de bodas? Recuerde, Dios es muy, él es muy generoso. Está muy complacido con cualquier esfuerzo que hagamos para poner en práctica las enseñanzas de Jesús. Pero si no estamos haciendo ningún esfuerzo para responder a la gracia de Dios, no estamos haciendo ningún esfuerzo para responder a la gracia de Dios, no estamos haciendo ningún esfuerzo para responder a la gracia de Dios, y para poner en práctica las enseñanzas del Sermón del Monte en nuestras vidas, entonces no tenemos el vestido de bodas. Y entonces Jesús realmente está emitiendo una advertencia por amor. No es una advertencia sin gracia, sino una advertencia llena de gracia que nos llama a tomar en serio nuestro discipulado. Y luego, por supuesto, un último comentario: esta es la forma en que esto se ha interpretado a menudo, que estamos llamados a extender esta invitación a cualquiera que venga a ser parte del evangelio. Y entonces, voy a pedirles que acepten esta invitación y voy a pedirles que acepten esta invitación y voy a pedirles que acepten esta invitación y voy a hablarles de las celebraciones de la próxima boda del hijo de este gran Rey lleno de gracia, que es nuestro Padre, y el Rey es nuestro Señor Jesús. Bueno, que el Señor los bendiga a todos. Espero que todos estén bien y los veremos la próxima vez."
    }
    
    print(f"Submitting job with GUID: {sermon_guid}")
    response = requests.post(f"{API_BASE_URL}/sermon", json=payload)
    if response.status_code == 201:
        print("✅ Job submitted successfully!")
    else:
        print("❌ Failed to submit job:", response.json())
        exit(1)
    return sermon_guid

def check_status(sermon_guid):
    response = requests.get(f"{API_BASE_URL}/status/{sermon_guid}")
    if response.status_code == 200:
        return response.json()
    else:
        print("❌ Failed to get status:", response.json())
        exit(1)

def download_audio(sermon_guid, download_path):
    print("Downloading audio file...")
    response = requests.get(f"{API_BASE_URL}/download/{sermon_guid}", stream=True)
    if response.status_code == 200:
        with open(download_path, "wb") as f:
            for chunk in response.iter_content(chunk_size=8192):
                f.write(chunk)
        print(f"✅ Audio downloaded successfully to {download_path}")
    else:
        print("❌ Failed to download audio:", response.json())

def main():
    # Submit a new sermon job
    sermon_guid = submit_job()
    
    # Poll for the job status every 10 seconds
    print("Checking job status every 10 seconds...")
    while True:
        status_info = check_status(sermon_guid)
        current_status = status_info.get("status")
        print(f"Job status: {current_status}")
        
        if current_status == "complete":
            download_audio(sermon_guid, f"{sermon_guid}.mp3")
            break
        elif current_status == "error":
            print("❌ Job encountered an error. Exiting.")
            break
        
        time.sleep(10)

if __name__ == "__main__":
    main()
